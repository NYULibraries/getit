/* update_html.js:  Provide functions to update content on page with background responses from Umlaut. Used by Umlaut itself, as well as by third party callers.*/
(function(a){function b(b){a.extend(this,b),this.selector==undefined&&(this.selector="#"+this.umlaut_section_id),this.position==undefined&&(this.position="html")}function d(c,d){d==undefined&&(d=""),c=c.replace(/\/$/,""),this.umlaut_uri=c+"/resolve/partial_html_sections?umlaut.response_format=json&"+d,this.section_targets=[],this.add_section_target=function(a){this.section_targets.push(new b(a))},this.complete=function(){},this.is_remote_url=function(a){var b=/^(\w+:)?\/\/([^\/?#]+)/,c=b.exec(a);return c&&(c[1]&&c[1]!==location.protocol||c[2]!==location.host)},this.update=function(){var b=this,c=this.is_remote_url(this.umlaut_uri)?"jsonp":"json";a.ajax({url:b.umlaut_uri,dataType:c,jsonp:"umlaut.jsonp",error:function(){a.error("Problem loading background elements.")},success:function(c){for(var d=0;d<b.section_targets.length;d++){var e=b.section_targets[d],f=b.find_umlaut_response_section(c,e.umlaut_section_id);if(f==undefined)continue;var g=null;typeof f.response_count!="undefined"&&(g=parseInt(f.response_count.value));var h=e.ensure_placement_destination(),i=a('<div class="umlaut" style="display:none" class="'+e.umlaut_section_id+'"></div>');i.html(f.html_content);var j=e.before_update(i,g,e);j!=0&&(h.replaceWith(i),e.host_div_element=i,i.show(),e.after_update(i,g,e))}if(c.partial_html_sections.in_progress){b.umlaut_uri=c.partial_html_sections.in_progress.refresh_url.replace(/[?;&]umlaut\.jsonp=[^;&]+/,"");var k=c.partial_html_sections.in_progress.requested_wait_seconds;window.setTimeout(function(){b.update()},k*1e3)}else{b.complete();for(var d=0;d<b.section_targets.length;d++){var e=b.section_targets[d];e.complete(e)}}}})},this.find_umlaut_response_section=function(b,c){return a.grep(b.partial_html_sections.html_section,function(a){return a.id==c})[0]}}var c=function(){};b.prototype.before_update=c,b.prototype.after_update=c,b.prototype.complete=c,b.prototype.ensure_placement_destination=function(){if(this.selector==undefined)return null;if(this.host_div_element)return this.host_div_element;var b=a('<div class="umlaut" style="display:none"></div>');return a(this.selector).eq(0)[this.position](b),this.host_div_element=b,this.host_div_element},window.Umlaut==undefined&&(window.Umlaut=new Object),window.Umlaut.HtmlUpdater=d,window.Umlaut.Loader=function(){this.load=function(a){typeof console!="undefined"&&typeof console.log!="undefined"&&console.log("WARN: Umlaut.Loader no longer supported in Umlaut 3.x, you have not loaded Umlaut JS Behaviors. See Umlaut documentation for new way.")}}})(jQuery)